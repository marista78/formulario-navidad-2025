import streamlit as st
import pandas as pd
from datetime import datetime
import json

# ConfiguraciÃ³n de la pÃ¡gina
st.set_page_config(
    page_title="Fiesta NavideÃ±a 2025",
    page_icon="ğŸ„",
    layout="wide"
)

# CSS personalizado para tema navideÃ±o
st.markdown("""
    <style>
    .main {
        background-color: #f0f8f0;
    }
    .stButton>button {
        background-color: #d42426;
        color: white;
        font-weight: bold;
        border-radius: 10px;
        padding: 10px 24px;
        font-size: 18px;
    }
    .stButton>button:hover {
        background-color: #a81c1e;
    }
    h1 {
        color: #165b33;
        text-align: center;
        font-size: 42px;
    }
    h2 {
        color: #d42426;
        font-size: 32px;
    }
    h3 {
        color: #165b33;
        font-size: 26px;
    }
    .info-box {
        background-color: #fff9e6;
        padding: 15px;
        border-radius: 10px;
        border-left: 5px solid #ffc107;
        margin: 10px 0;
        font-size: 17px;
    }
    .stTextInput label, .stTextArea label, .stRadio label, .stSelectbox label {
        font-size: 22px !important;
        font-weight: 600 !important;
        color: #2c3e50 !important;
    }
    .stRadio > div {
        font-size: 19px !important;
    }
    .stTextInput input, .stTextArea textarea {
        font-size: 17px !important;
    }
    .stRadio > label > div {
        font-size: 18px !important;
    }
    /* Hacer que todas las imÃ¡genes tengan el mismo tamaÃ±o */
    [data-testid="stImage"] img {
        height: 200px !important;
        width: 200px !important;
        object-fit: cover !important;
        border-radius: 10px;
        border: 3px solid #d42426;
        margin: 0 auto;
        display: block;    
    }
    /* Centrar los captions */
    [data-testid="stImage"] + div {
        text-align: center;
        font-weight: 600;
        color: #165b33;
        margin-top: 8px;
    }
    </style>
""", unsafe_allow_html=True)

# Inicializar session state
if 'seccion' not in st.session_state:
    st.session_state.seccion = 1
if 'respuestas' not in st.session_state:
    st.session_state.respuestas = {}

# FunciÃ³n para guardar respuestas
def guardar_respuestas():
    try:
        try:
            df = pd.read_csv('respuestas_navidad.csv')
        except:
            df = pd.DataFrame()
        
        st.session_state.respuestas['fecha_hora'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        nueva_respuesta = pd.DataFrame([st.session_state.respuestas])
        df = pd.concat([df, nueva_respuesta], ignore_index=True)
        
        df.to_csv('respuestas_navidad.csv', index=False)
        return True
    except Exception as e:
        st.error(f"Error al guardar: {e}")
        return False

# ENCABEZADO
st.title("ğŸ„ FIESTA NAVIDEÃ‘A 2025! ğŸ")

# Verificar si se acaba de enviar el formulario
if 'formulario_enviado' in st.session_state and st.session_state.formulario_enviado:
    st.success("ğŸ‰ Â¡Formulario enviado exitosamente!")
    st.balloons()
    st.markdown("""
    <div class="info-box">
    <h3 style='color: #165b33; text-align: center;'>Â¡Gracias por su participaciÃ³n!</h3>
    <p style='text-align: center;'>Sus respuestas han sido registradas. Nos vemos en la fiesta navideÃ±a el 19 de diciembre.</p>
    <p style='text-align: center;'><b>Â¡Feliz Navidad! ğŸ„ğŸ</b></p>
    </div>
    """, unsafe_allow_html=True)
    
  
    st.stop()

st.markdown("""
<div class="info-box">
<b>Â¡Hola papitos!</b> ğŸ„âœ¨<br><br>
Los invitamos a completar este formulario para organizar juntos nuestra fiesta navideÃ±a 2025. 
Sus respuestas nos ayudarÃ¡n a planificar un evento especial para todos.<br><br>
Â¡Gracias por su participaciÃ³n!
</div>
""", unsafe_allow_html=True)

st.markdown("---")

# SECCIÃ“N 1: DATOS DEL ALUMNO
if st.session_state.seccion >= 1:
    st.header("ğŸ“‹ SecciÃ³n 1 de 4")
    st.subheader("DATOS DEL ALUMNO")
    
    col1, col2 = st.columns([2, 2])
    
    with col1:
        nombre_alumno = st.text_input(
            "Escribir el nombre del Alumno *", 
            key="nombre_alumno",
            placeholder="Ej: Juan PÃ©rez"
        )
    
    st.write("")
    
    if st.button("Continuar a SecciÃ³n 2", key="btn_sec1"):
        if nombre_alumno:
            st.session_state.respuestas.update({
                'nombre_alumno': nombre_alumno
            })
            st.session_state.seccion = 2
            st.rerun()
        else:
            st.error("âš ï¸ Por favor completa todos los campos obligatorios (*)")

# SECCIÃ“N 2: DATOS PARA EL COMPARTIR
if st.session_state.seccion >= 2:
    st.markdown("---")
    st.header("ğŸ‰ SecciÃ³n 2 de 4")
    st.subheader("DATOS PARA EL COMPARTIR")
    
    st.info("ğŸ“… La fecha tentativa en la cual se realizarÃ¡ la reuniÃ³n serÃ¡ el 19 de diciembre")
    
    participa = st.radio("Â¿Vas a participar? *", ["SÃ­", "No"], key="participa")
    
    if participa == "No":
        st.success("âœ¨ Â¡Gracias por tu respuesta! Â¡Feliz Navidad! ğŸ„ğŸ")
        st.balloons()
        
        if st.button("Enviar respuesta", key="btn_enviar_no"):
            st.session_state.respuestas['participa'] = "No"
            if guardar_respuestas():
                st.session_state.seccion = 1
                st.session_state.respuestas = {}
                st.session_state.formulario_enviado = True
                st.rerun()
            else:
                st.error("âŒ Hubo un error al guardar la respuesta")
        st.stop()
    
    if st.button("Continuar a SecciÃ³n 3", key="btn_sec2"):
        if participa:
            st.session_state.respuestas['participa'] = participa
            st.session_state.seccion = 3
            st.rerun()
        else:
            st.error("âš ï¸ Por favor selecciona una opciÃ³n")

# SECCIÃ“N 3: DATOS PARA EL REGALO
if st.session_state.seccion >= 3:
    st.markdown("---")
    st.header("ğŸ SecciÃ³n 3 de 4")
    st.subheader("DATOS PARA EL REGALO")
    
    st.markdown("""
    <div class="info-box">
    <b>Estimados padres:</b><br><br>
    Las fotografÃ­as mostradas son referenciales. El regalo se elegirÃ¡ segÃºn la opciÃ³n con mÃ¡s votos.<br><br>
    <b>Importante:</b><br>
    â€¢ Marcar solo UNA opciÃ³n por pregunta<br>
    â€¢ Una vez que elijan el tipo de regalo, por favor seleccionen en la pregunta siguiente un precio acorde a dicha elecciÃ³n<br>
    â€¢ El monto seleccionado serÃ¡ el aporte individual por familia (se elegirÃ¡ el monto que tenga mÃ¡s votos)<br><br>
    Â¡Gracias por su participaciÃ³n!
    </div>
    """, unsafe_allow_html=True)
    
    st.write("")
    
    # Pregunta sobre tipo de regalo
    tipo_regalo_opcion = st.radio(
        "El regalo deberÃ­a ser? *",
        ["Igual para todos", "Diferente para niÃ±os y niÃ±as"],
        key="tipo_regalo_opcion"
    )
    
    st.write("")
    st.write("")
    
    # Pregunta sobre juguete preferido
    st.write("**Â¿QuÃ© tipo de juguete prefiere su hijo(a)? ***")
    st.write("")
    
    # Mostrar imÃ¡genes de referencia en grid 4x3
    st.write("**Opciones disponibles:**")
    st.write("")
    
    # Fila 1
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.image("imagenes/juego_mesa.jpg", caption="Juegos de Mesa")
    with col2:
        st.image("imagenes/munecas_barbie.jpg", caption="MuÃ±ecas")
    with col3:
        st.image("imagenes/juego_cocina.jpg", caption="Juegos de Cocina")
    with col4:
        st.image("imagenes/lego.jpg", caption="Lego")
    
    st.write("")
    
    # Fila 2
    col5, col6, col7, col8 = st.columns(4)
    with col5:
        st.image("imagenes/transformers.jpg", caption="Carritos/Transformers")
    with col6:
        st.image("imagenes/quimica.jpg", caption="Kit de QuÃ­mica")
    with col7:
        st.image("imagenes/pista.jpg", caption="Pistas de Carreras")
    with col8:
        st.image("imagenes/reloj.jpg", caption="Reloj Smartwatch")
    
    st.write("")
    
    # Fila 3
    col9, col10, col11, col12 = st.columns(4)
    with col9:
        st.image("imagenes/consola.jpg", caption="Consola Videojuegos")
    with col10:
        st.image("imagenes/camara.jpg", caption="CÃ¡mara Digital")
    with col11:
        st.write("")
    with col12:
        st.write("")
    
    st.write("")
    st.write("---")
    st.write("")
    
    # Lista desplegable para seleccionar
    opciones_juguetes = [
        "-- Seleccione una opciÃ³n --",
        "Juegos de Mesa (Monopoly, Jenga, Uno, etc.)",
        "MuÃ±ecas (Barbie, Frozen, etc.)",
        "Juegos de Cocina",
        "Lego",
        "Carritos/Transformers",
        "Kit de QuÃ­mica",
        "Pistas de carreras",
        "Reloj Inteligente Smartwatch (S/30 - S/40)",
        "Consola de Videojuegos (S/50 - S/60)",
        "CÃ¡mara Digital Infantil (S/40 - S/50)",
        "Otro"
    ]
    
    juguete_preferido = st.selectbox(
        "**Seleccione su opciÃ³n de la lista:**",
        options=opciones_juguetes,
        index=0,
        key="juguete"
    )
    
    # Si seleccionÃ³ el placeholder, considerarlo como None
    if juguete_preferido == "-- Seleccione una opciÃ³n --":
        juguete_preferido = None
    
    otro_juguete = ""
    if juguete_preferido == "Otro":
        otro_juguete = st.text_input("Por favor especifica quÃ© otro juguete:", key="otro_juguete", placeholder="Ej: Rompecabezas, Instrumentos musicales, etc.")
    
    st.write("")
    st.write("")
    
    # Pregunta sobre precio
    precio = st.radio(
        "Â¿CuÃ¡nto deberÃ­a costar el regalo? (Soles) *",
        ["20", "25", "30", "35", "40", "50"],
        key="precio"
    )
    
    if st.button("Continuar a SecciÃ³n 4", key="btn_sec3"):
        if tipo_regalo_opcion and juguete_preferido and precio:
            st.session_state.respuestas.update({
                'tipo_regalo_opcion': tipo_regalo_opcion,
                'juguete_preferido': juguete_preferido,
                'otro_juguete': otro_juguete if juguete_preferido == "Otro" else "",
                'precio': precio
            })
            st.session_state.seccion = 4
            st.rerun()
        else:
            st.error("âš ï¸ Por favor completa todos los campos obligatorios (*)")

# SECCIÃ“N 4: COMISIONES
if st.session_state.seccion >= 4:
    st.markdown("---")
    st.header("ğŸ‘¥ SecciÃ³n 4 de 4")
    st.subheader("PARTICIPACIÃ“N EN COMISIONES")
    
    # Contar cuÃ¡ntas personas hay en cada comisiÃ³n
    def contar_comisiones():
        try:
            df = pd.read_csv('respuestas_navidad.csv')
            if 'comision' in df.columns:
                return df['comision'].value_counts().to_dict()
            return {}
        except:
            return {}
    
    # Definir lÃ­mites de cada comisiÃ³n
    limites_comisiones = {
        "Forrado de regalos (2 personas)": 2,
        "Limpieza del lugar (antes del show) (3 personas)": 3,
        "DecoraciÃ³n del lugar (4 personas)": 4,
        "Limpieza del lugar (despuÃ©s del show) (3 personas)": 3
    }
    
    # Obtener el conteo actual
    conteo = contar_comisiones()
    
    # Crear las opciones con disponibilidad
    opciones_disponibles = []
    opciones_completas = []
    
    st.write("**Disponibilidad de comisiones:**")
    st.write("")
    
    for comision, limite in limites_comisiones.items():
        actual = conteo.get(comision, 0)
        disponibles = limite - actual
        
        if disponibles > 0:
            # Mostrar en verde - disponible
            st.markdown(f"âœ… **{comision}** - Disponibles: {disponibles}/{limite}")
            opciones_disponibles.append(comision)
        else:
            # Mostrar en rojo - completa
            st.markdown(f"âŒ **{comision}** - COMPLETA ({limite}/{limite})")
            opciones_completas.append(comision)
    
    st.write("")
    st.write("---")
    st.write("")
    
    # Si hay opciones disponibles
    if opciones_disponibles:
        comision = st.radio(
            "Â¿En quÃ© comisiÃ³n le gustarÃ­a participar? *",
            opciones_disponibles,
            key="comision"
        )
    else:
        st.error("âš ï¸ Lo sentimos, todas las comisiones estÃ¡n completas.")
        comision = None
    
    st.write("")
    
    comentarios = st.text_area(
        "Comentarios adicionales (opcional)",
        placeholder="Si tiene algÃºn comentario o sugerencia, por favor escrÃ­balo aquÃ­...",
        key="comentarios"
    )
    
    st.write("")
    
    if st.button("âœ… ENVIAR FORMULARIO", key="btn_final", type="primary"):
        if comision:
            st.session_state.respuestas.update({
                'comision': comision,
                'comentarios': comentarios
            })
            
            if guardar_respuestas():
                # Reiniciar variables y marcar como enviado
                st.session_state.seccion = 1
                st.session_state.respuestas = {}
                st.session_state.formulario_enviado = True
                st.rerun()
            else:
                st.error("âŒ Hubo un error al enviar el formulario. Por favor intenta nuevamente.")
        else:
            st.error("âš ï¸ Por favor selecciona una comisiÃ³n")